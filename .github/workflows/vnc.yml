name: noVNC RDP

on:
  workflow_dispatch:

jobs:
  run-vnc:
    runs-on: ubuntu-latest

    steps:
    - name: Install desktop + lightweight audio
      run: |
        sudo apt update
        sudo apt install -y xfce4 xfce4-goodies
        sudo apt install -y tigervnc-standalone-server pulseaudio

    - name: Start PulseAudio (audio server)
      run: |
        pulseaudio --start

    - name: Start VNC server (display :1)
      run: |
        mkdir -p ~/.vnc
        echo "" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd
        vncserver :1 -geometry 1366x768

    - name: Download noVNC + websockify
      run: |
        git clone https://github.com/novnc/noVNC
        git clone https://github.com/novnc/websockify
        ln -s websockify noVNC/utils/websockify

    - name: Start noVNC
      run: |
        ./noVNC/utils/novnc_proxy --vnc localhost:5901 --listen 6080 &

    - name: Install WebRTC streamer (for audio + video)
      run: |
        sudo apt install -y cmake libmicrohttpd-dev libasound2-dev libv4l-dev libopus-dev libx264-dev
        git clone https://github.com/mpromonet/webrtc-streamer
        cd webrtc-streamer && cmake . && make -j4

    - name: Start WebRTC-streamer (audio + screen)
      run: |
        cd webrtc-streamer
        ./webrtc-streamer -H 0.0.0.0:8000 "screen://0" &

    - name: Install cloudflared
      run: |
        wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb

    - name: Launch Cloudflare tunnel (anonymous)
      run: |
        cloudflared tunnel --url http://localhost:6080 --metrics 0 &
        cloudflared tunnel --url http://localhost:8000 --metrics 0 &
        sleep 5

    - name: Show tunnel URLs
      run: |
        grep -o "https://.*trycloudflare.com" <(ps aux | grep cloudflared)
