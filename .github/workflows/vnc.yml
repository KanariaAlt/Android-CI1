name: noVNC + WebRTC

on:
  workflow_dispatch:

jobs:
  run-vnc:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Install desktop & VNC
      run: |
        sudo apt update -o Acquire::AllowInsecureRepositories=true
        sudo apt install -y xfce4 xfce4-goodies \
        tightvncserver pulseaudio xclip wget tar git novnc websockify curl x11-xserver-utils --allow-unauthenticated
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt update -o Acquire::AllowInsecureRepositories=true
        sudo apt install -y google-chrome-stable --allow-unauthenticated
        pulseaudio --start
        
        mkdir -p ~/.vnc
        echo "" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd
        
        # xstartup
        cat > ~/.vnc/xstartup <<EOF
        #!/bin/sh
        unset SESSION_MANAGER
        unset DBUS_SESSION_BUS_ADDRESS
        startxfce4 &
        EOF
        chmod +x ~/.vnc/xstartup
        export DISPLAY=:1
        vncserver :1 -geometry 1366x768 -depth 24 -localhost
        websockify --web /usr/share/novnc/ --wrap-mode=ignore 6080 localhost:5901 --idle-timeout 0 &
        echo "noVNC is running on port 6080"

        export VNC_CLIPBOARD=1

    - name: Add Waydroid repo and install Waydroid
      run: |
        curl https://repo.waydro.id | sudo bash
        sudo apt update
        sudo apt install -y waydroid

    - name: Stop any running Waydroid / cleanup
      run: |
        sudo systemctl stop waydroid-container || true
        sudo pkill -9 waydroid || true
        sudo pkill -9 waydroid-container || true

    - name: Prepare custom images directory
      run: |
        sudo mkdir -p /etc/waydroid-extra/images

    - name: Download custom Waydroid system & vendor images
      run: |
        cd $(mktemp -d)
        wget -O system.zip "https://sourceforge.net/projects/waydroid/files/images/system/lineage/waydroid_x86_64/lineage-20.0-20250809-GAPPS-waydroid_x86_64-system.zip/download"
        wget -O vendor.zip "https://sourceforge.net/projects/waydroid/files/images/vendor/waydroid_x86_64/lineage-20.0-20250809-MAINLINE-waydroid_x86_64-vendor.zip/download"
        sudo unzip system.zip -d /etc/waydroid-extra/images
        sudo unzip vendor.zip -d /etc/waydroid-extra/images

    - name: Disable kernel (+ binder) for Waydroid
      run: |
        sudo mkdir -p /etc/waydroid
        echo "[waydroid]" | sudo tee /etc/waydroid/waydroid.cfg
        echo "disable_binder=true" | sudo tee -a /etc/waydroid/waydroid.cfg
        echo "disable_module_load=true" | sudo tee -a /etc/waydroid/waydroid.cfg
        echo "WAYDROID_DISABLE_BINDER=1" | sudo tee -a /etc/environment
        echo "WAYDROID_DISABLE_MODULE_LOAD=1" | sudo tee -a /etc/environment
        source /etc/environment

    - name: Init Waydroid (NO KERNEL MODE)
      run: |
        sudo -E WAYDROID_DISABLE_BINDER=1 WAYDROID_DISABLE_MODULE_LOAD=1 \
          waydroid --details-to-stdout init -s GAPPS -f

    - name: Start Waydroid container
      run: |
        export WAYDROID_DISABLE_BINDER=1
        export WAYDROID_DISABLE_MODULE_LOAD=1
        sudo waydroid container start
        sleep 10

    - name: Start Waydroid GUI session in Xvfb
      run: |
        export DISPLAY=:1
        sudo -E WAYDROID_DISABLE_BINDER=1 WAYDROID_DISABLE_MODULE_LOAD=1 \
          waydroid session start &
        sleep 10

    - name: Install Cloudflared tunnel
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb

    - name: Expose noVNC public URL
      run: |
          echo "Creating public tunnel..."
          cloudflared tunnel --url http://localhost:6080 --no-autoupdate > log.txt 2>&1 &
          sleep 10
          echo "=============================================="
          grep -o 'https://.*trycloudflare.com' log.txt
          echo "=============================================="
          echo "Keep this Actions job running to maintain connection."
          tail -f /dev/null
