name: XFCE noVNC Cloudflare

on:
  workflow_dispatch:

jobs:
  desktop:
    runs-on: ubuntu-latest

    steps:
    - name: Update system
      run: sudo apt update

    - name: Install XFCE, VNC, noVNC
      run: |
        sudo apt install -y xfce4 xfce4-goodies tigervnc-standalone-server novnc websockify
          mkdir -p ~/.vnc
        echo "1" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd
                vncserver -kill :1 || true
        vncserver -geometry 1600x900 :1

        nohup websockify --web=/usr/share/novnc 6080 localhost:5901 >/dev/null 2>&1 &
                wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb
                mkdir -p ~/.cloudflared
        cloudflared tunnel \
          --url http://localhost:6080 \
          --loglevel info \
          2>&1 | tee ~/.cloudflared/cf.log &
                  grep -Eo "https://[a-zA-Z0-9.-]+\.trycloudflare\.com" \
          ~/.cloudflared/cf.log | head -n 1

    - name: Keep runner alive (6 hours)
      run: sleep 21600
