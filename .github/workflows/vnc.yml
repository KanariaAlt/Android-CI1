name: noVNC RDP

on:
  workflow_dispatch:

jobs:
  desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Desktop + PulseAudio + Mesa (llvmpipe)
        run: |
          sudo apt update
          sudo apt install -y \
            lxde x11vnc xvfb x11-xserver-utils \
            pulseaudio ffmpeg curl wget git \
            libopus0 nodejs npm \
            mesa-utils \
            libgl1 \
            libglx-mesa0 \
            mesa-va-drivers \
            mesa-vulkan-drivers \
            libegl1 \
            libegl-mesa0 \
            libgbm1

          # Start audio server
          pulseaudio --start

      - name: Enable llvmpipe Rendering (software GPU)
        run: |
          echo "DISPLAY=:1" >> $GITHUB_ENV
          echo "MESA_LOADER_DRIVER_OVERRIDE=llvmpipe" >> $GITHUB_ENV
          echo "GALLIUM_DRIVER=llvmpipe" >> $GITHUB_ENV
          echo "LIBGL_ALWAYS_SOFTWARE=1" >> $GITHUB_ENV

      - name: Start X server (Xvfb) + LXDE + x11vnc
        run: |
          export DISPLAY=:1
          Xvfb :1 -screen 0 1280x720x24 -ac +extension RANDR &
          sleep 2

          startlxde &
          sleep 3

          x11vnc -display :1 -nopw -forever -shared -quiet &
          sleep 2

      - name: Install WebRTC Streamer
        run: |
          git clone https://github.com/mpromonet/webrtc-streamer
          cd webrtc-streamer
          mkdir build && cd build
          cmake ..
          make -j$(nproc)
          sudo cp webrtc-streamer /usr/local/bin/

      - name: Start WebRTC Streamer (auto resolution + audio)
        run: |
          export DISPLAY=:1
          webrtc-streamer \
            -H 8000 \
            -C "\"pulse\"" \
            -O 3000 \
            -a default \
            -V "x11grab?framerate=30&draw_mouse=1&use_rw=1" \
            --size=0x0 \
            > webrtc.log 2>&1 &

          sleep 3
          echo "WebRTC Streamer started."

      - name: Install Cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Expose WebRTC public URL
        run: |
          cloudflared tunnel --url http://localhost:8000 --no-autoupdate > log.txt 2>&1 &
          sleep 12
          echo "======================================="
          echo "PUBLIC WEBRTC DESKTOP URL:"
          grep -o 'https://.*trycloudflare.com' log.txt
          echo "======================================="
          tail -f /dev/null
