name: XFCE + noVNC + QEMU Android (GApps + Window Mode)

on:
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
    - name: Update system
      run: sudo apt update

    - name: Install XFCE, VNC, noVNC, Websockify
      run: |
        sudo apt install -y xfce4 xfce4-goodies tigervnc-standalone-server novnc websockify

        mkdir -p ~/.vnc
        echo "Password123" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd

        vncserver -kill :1 || true
        vncserver -geometry 1360x768 :1

        nohup websockify --web=/usr/share/novnc 6080 localhost:5901 >/dev/null 2>&1 &

    - name: Install QEMU
      run: |
        sudo apt install -y qemu-kvm qemu-utils qemu-system-x86 \
        libgtk-3-0 libgtk-3-bin libglib2.0-0

    - name: Download Android-x86 + GApps
      run: |
        wget -O android.iso https://mirrors.osdn.net/android-x86/9.0-r2/android-x86_64-9.0-r2-GAPPS.iso

    - name: Create QEMU disk
      run: qemu-img create -f qcow2 android.qcow2 16G

    - name: Start QEMU inside XFCE (as window, with GApps)
      run: |
        sleep 10

        DISPLAY=:1 nohup qemu-system-x86_64 \
          -m 4096 \
          -smp 4 \
          -cdrom android.iso \
          -hda android.qcow2 \
          -boot d \
          -enable-kvm \
          -vga virtio \
          -display gtk \
          >/dev/null 2>&1 &

    - name: Install Cloudflare Tunnel
      run: |
        wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb

        mkdir -p ~/.cloudflared
        nohup cloudflared tunnel --url http://localhost:6080 > ~/.cloudflared/cf.log 2>&1 &

    - name: Show Tunnel URL
      run: |
        sleep 5
        cat ~/.cloudflared/cf.log | grep "https://"
        echo "=============================="
        echo "XFCE Desktop + QEMU Android with GApps"
        echo "=============================="
        cat ~/.cloudflared/cf.log | grep "https://"

    - name: Keep runner alive 6 hours
      run: |
        echo "Running..."
        sleep 21600
