name: noVNC + WebRTC RDP

on:
  workflow_dispatch:

jobs:
  run-vnc:
    runs-on: ubuntu-latest
    steps:
    - name: Install desktop & VNC
      run: |
        sudo apt update
        sudo apt install -y xfce4 xfce4-goodies tigervnc-standalone-server
        sudo apt install -y pulseaudio xclip wget tar git novnc websockify

    - name: Start PulseAudio
      run: pulseaudio --start

    - name: Setup VNC password
      run: |
        mkdir -p ~/.vnc
        echo "" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd
        # xstartup
        cat > ~/.vnc/xstartup <<EOF
        #!/bin/sh
        unset SESSION_MANAGER
        unset DBUS_SESSION_BUS_ADDRESS
        startxfce4 &
        EOF
        chmod +x ~/.vnc/xstartup
        export VNC_CLIPBOARD=1
        vncserver :1 -geometry 1366x768 -SecurityTypes None
        # Start noVNC
        websockify --web /usr/share/novnc/ --wrap-mode=ignore 6080 localhost:5901 &
        echo "noVNC running on port 6080"

    - name: Start noVNC
      run: |
        ./noVNC/utils/novnc_proxy --vnc localhost:5901 --listen 6080 &
        sleep 3

    - name: Download and run WebRTC-streamer safely
      run: |
        mkdir -p /tmp/webrtc && cd /tmp/webrtc
        wget -O webrtc-streamer.tar.gz https://github.com/mpromonet/webrtc-streamer/releases/download/v0.8.13/webrtc-streamer-v0.8.13-Linux-x86_64-Release.tar.gz
        tar -xzf webrtc-streamer.tar.gz
        BINARY=$(find . -type f -executable -name "*webrtc*" | head -1)
        if [ -z "$BINARY" ]; then
          echo "Biner webrtc-streamer tidak ditemukan!"
          exit 1
        fi
        chmod +x "$BINARY"
        echo "Menjalankan webrtc-streamer: $BINARY"
        "./$BINARY" -H 0.0.0.0:8000 "screen://0" &

    - name: Install cloudflared
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb

    - name: Start Cloudflare tunnels and show public URLs
      run: |
        echo "Starting Cloudflare tunnels..."
        
        # Jalankan tunnel di background dan simpan log
        cloudflared tunnel --url http://localhost:6080 --metrics 0 --loglevel info > /tmp/tunnel6080.log 2>&1 &
        cloudflared tunnel --url http://localhost:8000 --metrics 0 --loglevel info > /tmp/tunnel8000.log 2>&1 &
        
        # Tunggu URL muncul max 20 detik
        echo "Waiting for Cloudflare URLs..."
        for i in {1..20}; do
          URL6080=$(grep -o 'https://[a-zA-Z0-9.-]*\.trycloudflare.com' /tmp/tunnel6080.log || true)
          URL8000=$(grep -o 'https://[a-zA-Z0-9.-]*\.trycloudflare.com' /tmp/tunnel8000.log || true)
          if [[ -n "$URL6080" && -n "$URL8000" ]]; then
            break
          fi
          sleep 1
        done

        echo "Public URL for noVNC: ${URL6080:-not found}"
        echo "Public URL for WebRTC-streamer: ${URL8000:-not found}"

    - name: Keep workflow running
      run: tail -f /dev/null
