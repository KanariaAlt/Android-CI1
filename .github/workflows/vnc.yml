name: XFCE noVNC Cloudflare

on:
  workflow_dispatch:

jobs:
  desktop:
    runs-on: ubuntu-latest

    steps:
    - name: Update system
      run: sudo apt update

    - name: Install XFCE, VNC, noVNC
      run: |
        sudo apt install -y \
          xfce4 xfce4-goodies \
          tigervnc-standalone-server \
          novnc websockify

        mkdir -p ~/.vnc
        echo "1" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd

        cat <<EOF > ~/.vnc/xstartup
        #!/bin/sh
        unset SESSION_MANAGER
        unset DBUS_SESSION_BUS_ADDRESS
        exec startxfce4 &
        EOF

        chmod +x ~/.vnc/xstartup

        vncserver -kill :1 || true
        vncserver -geometry 1600x900 :1

        nohup websockify \
          --web=/usr/share/novnc \
          6080 localhost:5901 \
          >/tmp/novnc.log 2>&1 &

    - name: Verify noVNC
      run: |
        ss -tlnp | grep 6080
        echo "noVNC running on port 6080"

    - name: Install QEMU
      run: |
        sudo apt install -y \
          qemu-kvm qemu-utils qemu-system-x86 \
          libgtk-3-0 libglib2.0-0

    - name: Install cloudflared
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb

    - name: Start Cloudflare Tunnel
      run: |
        mkdir -p ~/.cloudflared

        cloudflared tunnel \
          --url http://localhost:6080 \
          --loglevel info \
          2>&1 | tee ~/.cloudflared/cf.log &

    - name: Show Tunnel URL
      run: |
        echo "Waiting for tunnel..."
        sleep 10
        echo "=============================="
        echo "XFCE Desktop (noVNC)"
        echo "=============================="
        grep -Eo "https://[a-zA-Z0-9.-]+\.trycloudflare\.com" \
          ~/.cloudflared/cf.log | head -n 1

    - name: Keep runner alive (6 hours)
      run: sleep 21600
