name: XFCE + noVNC + QEMU Android (GApps + Window Mode)

on:
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
    - name: Update system
      run: sudo apt update

    - name: Install XFCE, VNC, noVNC, Websockify
      run: |
        sudo apt install -y xfce4 xfce4-goodies tigervnc-standalone-server novnc websockify

        mkdir -p ~/.vnc
        echo "1" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd

        vncserver -kill :1 || true
        vncserver -geometry 1600x900 :1

        nohup websockify --web=/usr/share/novnc 6080 localhost:5901 >/dev/null 2>&1 &

    - name: Install QEMU
      run: |
        sudo apt install -y qemu-kvm qemu-utils qemu-system-x86 \
        libgtk-3-0 libgtk-3-bin libglib2.0-0

    - name: Download Bliss OS Android 12 + GApps ISO
      run: |
        wget -O bliss.iso "https://sourceforge.net/projects/blissos-dev/files/Android-Generic/PC/aosp/gapps/12/android_x86_64-a12_r27-03.04.22-01-mesa22-ksu-gapps-treble-libndk-sleep-sd-libva.iso/download"

    - name: Create virtual disk for Android
      run: qemu-img create -f qcow2 android.qcow2 16G

    - name: Start QEMU (Bliss OS Android 12) inside XFCE
      run: |
        # Wait a bit so XFCE + VNC server fully up
        sleep 15

        # Launch QEMU with GTK display on DISPLAY :1 (XFCE VNC session)
        DISPLAY=:1 nohup qemu-system-x86_64 \
          -m 4096 \
          -smp 4 \
          -cdrom bliss.iso \
          -hda android.qcow2 \
          -boot d \
          -enable-kvm \
          -vga virtio \
          -display gtk \
          >/dev/null 2>&1 &

    - name: Install Cloudflare Tunnel
      run: |
        wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb

        mkdir -p ~/.cloudflared
        nohup cloudflared tunnel --url http://localhost:6080 > ~/.cloudflared/cf.log 2>&1 &

    - name: Show Tunnel URL
      run: |
        sleep 5
        cat ~/.cloudflared/cf.log | grep "https://"
        echo "=============================="
        echo "XFCE Desktop + QEMU Android with GApps"
        echo "=============================="
        cat ~/.cloudflared/cf.log | grep "https://"

    - name: Keep runner alive 6 hours
      run: |
        echo "Running..."
        sleep 21600
