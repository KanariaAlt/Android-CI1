name: Hyprland-Hyprdots-WebVNC

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Fix mirrors
      run: |
        sudo sed -i 's|azure.archive.ubuntu.com|archive.ubuntu.com|g' /etc/apt/sources.list
        sudo apt-get update --fix-missing

    - name: Install GCC 14
      run: |
        sudo apt-get install -y gcc-14 g++-14
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-14 100
        sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-14 100
        gcc --version
        g++ --version

    - name: Install base dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential cmake meson ninja-build pkg-config \
          git curl wget unzip gettext dbus-x11 \
          libdisplay-info-dev libdrm-dev libgbm-dev libinput-dev \
          libpixman-1-dev libseat-dev libsystemd-dev \
          libudev-dev libxkbcommon-dev libxcb1-dev libxcb-render0-dev \
          libxcb-composite0-dev libxcb-present-dev libxcb-xfixes0-dev \
          libxcb-shm0-dev libvulkan-dev \
          libegl1-mesa-dev libgles2-mesa-dev libgl1-mesa-dev \
          libwayland-dev wayland-protocols \
          liburing-dev libinih-dev libpugixml-dev libmtdev-dev libwacom-dev \
          libgtk-3-dev libglib2.0-dev libzip-dev librsvg2-dev libmagic-dev libjpeg-dev libwebp-dev libpng-dev libcairo2-dev \
          libpangocairo-1.0-0 libpixman-1-dev librsvg2-dev libre2-dev libxcb-res0-dev libinotifytools0-dev
       
        sudo apt install -y \
          libxcursor-dev libxcb-ewmh-dev libxcb-icccm4-dev libxcb-xinerama0-dev \
          libpango1.0-dev libcairo2-dev
        
        sudo apt install -y \
          libvirglrenderer-dev libsdl2-dev xwayland

    - name: Build xcb-errors
      run: |
        git clone https://github.com/Airblader/xcb-errors.git ~/xcb-errors
        cd ~/xcb-errors
        meson setup build --prefix=/usr
        ninja -C build
        sudo ninja -C build install

    - name: Build epoll-shim
      run: |
        git clone https://github.com/Airblader/epoll-shim.git ~/epoll-shim
        cd ~/epoll-shim
        meson setup build --prefix=/usr
        ninja -C build
        sudo ninja -C build install

    - name: Build wlroots (patched calloc)
      run: |
        git clone https://gitlab.freedesktop.org/wlroots/wlroots.git --branch 0.17.0 ~/wlroots
        cd ~/wlroots

        echo "=== calloc patch ==="
        sed -i 's/calloc(sizeof(unsigned int), \(group->[^)]*\))/calloc(\1, sizeof(unsigned int))/g' backend/libinput/tablet_pad.c

        echo "=== COMPILE wlroots ==="
        meson setup build --prefix=/usr
        ninja -C build
        sudo ninja -C build install

    - name: Build hyprutils
      run: |
        git clone https://github.com/hyprwm/hyprutils.git ~/hyprutils
        cd ~/hyprutils
        cmake --no-warn-unused-cli -DCMAKE_BUILD_TYPE:STRING=Release -DCMAKE_INSTALL_PREFIX:PATH=/usr -S . -B ./build
        cmake --build ./build --config Release --target all -j`nproc 2>/dev/null || getconf NPROCESSORS_CONF`
        sudo cmake --install build

    - name: Build hyprlang
      run: |
        git clone https://github.com/hyprwm/hyprlang.git
        cd hyprlang
        cmake --no-warn-unused-cli -DCMAKE_BUILD_TYPE:STRING=Release -DCMAKE_INSTALL_PREFIX:PATH=/usr -S . -B ./build
        cmake --build ./build --config Release --target hyprlang -j`nproc 2>/dev/null || getconf _NPROCESSORS_CONF`
        sudo cmake --install build

    - name: Build hyprwayland-scanner
      run: |
        git clone https://github.com/hyprwm/hyprwayland-scanner.git ~/hyprwayland-scanner
        cd ~/hyprwayland-scanner
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
        cmake --build build -j$(nproc)
        sudo cmake --install build

    - name: Build libinput
      run: |
        sudo apt remove -y libinput-dev
        git clone https://gitlab.freedesktop.org/libinput/libinput.git ~/libinput
        cd ~/libinput
        meson setup build --prefix=/usr
        ninja -C build
        sudo ninja -C build install

    - name: Build Aquamarine
      run: |
        git clone https://github.com/hyprwm/aquamarine.git ~/aquamarine
        cd ~/aquamarine
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
        cmake --build build --target all -j$(nproc)
        sudo cmake --install build

    - name: Build tomlplusplus
      run: |
        git clone https://github.com/marzer/tomlplusplus.git ~/tomlplusplus
        sudo cp -r ~/tomlplusplus/include/toml++ /usr/include/
        # buat pkg-config file supaya CMake bisa menemukan tomlplusplus
        echo "prefix=/usr
        exec_prefix=\${prefix}
        includedir=\${prefix}/include
        libdir=\${exec_prefix}/lib

        Name: tomlplusplus
        Description: Header-only toml++ library
        Version: 3.3.0
        Cflags: -I\${includedir}/toml++
        Libs:
          " | sudo tee /usr/lib/x86_64-linux-gnu/pkgconfig/tomlplusplus.pc

    - name: Build hyprcursor
      run: |
        git clone https://github.com/hyprwm/hyprcursor.git ~/hyprcursor
        cd ~/hyprcursor
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr 
        cmake --build build --target all -j$(nproc)
        sudo cmake --install build

    - name: Build hyprgraphics
      run: |
        git clone https://github.com/hyprwm/hyprgraphics.git ~/hyprgraphics
        cd ~/hyprgraphics
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
        cmake --build build -j$(nproc)
        sudo cmake --install build

    - name: Build Hyprland from source
      run: |
        wget https://github.com/hyprwm/Hyprland/releases/download/v0.52.1/source-v0.52.1.tar.gz
        tar xf source-v0.52.1.tar.gz
        SRC_DIR=$(tar tf source-v0.52.1.tar.gz | head -1 | cut -f1 -d"/")
        cd "$SRC_DIR"
        meson setup build --prefix=/usr
        ninja -C build
        sudo ninja -C build install

    - name: Install Hyprdots dependencies
      run: |
        sudo apt install -y \
          kitty rofi-wayland waybar mako-notifier \
          swww fonts-font-awesome zsh fish
        pip3 install --user pywal

    - name: Clone Hyprdots
      run: |
        git clone https://github.com/end-4/dots-hyprland ~/hyprdots
        chmod +x ~/hyprdots/setup

    - name: Install Hyprdots
      run: |
        cd ~/hyprdots
        ./setup install || true

    - name: Create Headless Hyprland Config
      run: |
        mkdir -p ~/.config/hypr
        cat > ~/.config/hypr/headless.conf <<EOF
        monitor=,preferred,auto,1
        exec-once=swww init
        exec-once=waybar
        exec-once=mako
        exec-once=kitty
        EOF

    - name: Start Hyprland (headless)
      run: |
        export WLR_BACKENDS=headless
        export WLR_RENDERER=vulkan
        export WLR_RENDERER_ALLOW_SOFTWARE=1
        export LIBGL_DRIVERS_PATH=/usr/lib/x86_64-linux-gnu/dri
        export GALLIUM_DRIVER=llvmpipe

        Hyprland --config ~/.config/hypr/headless.conf &
        sleep 10

    - name: Install WayVNC
      run: sudo apt install -y wayvnc

    - name: Start WayVNC
      run: |
        echo "" > ~/.vncpass
        wayvnc --address 0.0.0.0 --password-file ~/.vncpass &
        sleep 5

    - name: Install noVNC
      run: sudo apt install -y novnc websockify

    - name: Start noVNC
      run: |
        websockify --web /usr/share/novnc/ 6080 localhost:5900 &
        sleep 4

    - name: Install Cloudflared
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb

    - name: Start Tunnel
      run: |
        cloudflared tunnel --url http://localhost:6080 --no-autoupdate > log.txt 2>&1 &
        sleep 10
        echo "=============================================="
        echo "Public URL:"
        grep -o 'https://.*trycloudflare.com' log.txt
        echo "=============================================="

    - name: Keep alive
      run: tail -f /dev/null
