name: Hyprland-Hyprdots-WebVNC

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install base dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential cmake meson ninja-build pkg-config \
          git curl wget unzip gettext dbus-x11 \
          libdisplay-info-dev libdrm-dev libgbm-dev libinput-dev \
          libpixman-1-dev libseat-dev libsystemd-dev \
          libudev-dev libxkbcommon-dev libxcb1-dev libxcb-render0-dev \
          libxcb-composite0-dev libxcb-present-dev libxcb-xfixes0-dev \
          libxcb-shm0-dev libvulkan-dev \
          libegl1-mesa-dev libgles2-mesa-dev libgl1-mesa-dev \
          libwayland-dev wayland-protocols \
          elogind liburing-dev libinih-dev
       
        sudo apt install -y \
          libxcursor-dev libxcb-ewmh-dev libxcb-icccm4-dev libxcb-xinerama0-dev \
          libpango1.0-dev libcairo2-dev
        
        sudo apt install -y \
          libvirglrenderer-dev libsdl2-dev xwayland

    - name: Build wlroots
      run: |
        git clone https://gitlab.freedesktop.org/wlroots/wlroots.git --branch 0.17.0 ~/wlroots
        cd ~/wlroots
        meson setup build --prefix=/usr
        ninja -C build
        sudo ninja -C build install

    - name: Build hyprlang
      run: |
        git clone https://github.com/hyprwm/hyprlang.git ~/hyprlang
        cd ~/hyprlang
        meson setup build --prefix=/usr
        ninja -C build
        sudo ninja -C build install

    - name: Build Hyprland from source
      run: |
        wget https://github.com/hyprwm/Hyprland/releases/download/v0.52.1/source-v0.52.1.tar.gz
        tar xf source-v0.52.1.tar.gz
        cd source-v0.52.1
        meson setup build --prefix=/usr
        ninja -C build
        sudo ninja -C build install

    - name: Install Hyprdots dependencies
      run: |
        sudo apt install -y \
          kitty rofi-wayland waybar mako-notifier \
          swww fonts-font-awesome zsh fish
        pip3 install --user pywal

    - name: Clone Hyprdots
      run: |
        git clone https://github.com/end-4/dots-hyprland ~/hyprdots
        chmod +x ~/hyprdots/setup

    - name: Install Hyprdots
      run: |
        cd ~/hyprdots
        ./setup install || true

    - name: Create Headless Hyprland Config
      run: |
        mkdir -p ~/.config/hypr
        cat > ~/.config/hypr/headless.conf <<EOF
        monitor=,preferred,auto,1
        exec-once=swww init
        exec-once=waybar
        exec-once=mako
        exec-once=kitty
        EOF

    - name: Start Hyprland (headless)
      run: |
        export WLR_BACKENDS=headless
        export WLR_RENDERER=vulkan
        export WLR_RENDERER_ALLOW_SOFTWARE=1
        export LIBGL_DRIVERS_PATH=/usr/lib/x86_64-linux-gnu/dri
        export GALLIUM_DRIVER=llvmpipe

        Hyprland --config ~/.config/hypr/headless.conf &
        sleep 10

    - name: Install WayVNC
      run: sudo apt install -y wayvnc

    - name: Start WayVNC
      run: |
        echo "" > ~/.vncpass
        wayvnc --address 0.0.0.0 --password-file ~/.vncpass &
        sleep 5

    - name: Install noVNC
      run: sudo apt install -y novnc websockify

    - name: Start noVNC
      run: |
        websockify --web /usr/share/novnc/ 6080 localhost:5900 &
        sleep 4

    - name: Install Cloudflared
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb

    - name: Start Tunnel
      run: |
        cloudflared tunnel --url http://localhost:6080 --no-autoupdate > log.txt 2>&1 &
        sleep 10
        echo "=============================================="
        echo "Public URL:"
        grep -o 'https://.*trycloudflare.com' log.txt
        echo "=============================================="

    - name: Keep alive
      run: tail -f /dev/null
