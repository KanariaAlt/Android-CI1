name: Hyprland-WebVNC-VirtualGPU

on:
  workflow_dispatch:

jobs:
  hyprland:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install System Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            git cmake meson ninja-build build-essential pkg-config \
            libwayland-dev wayland-protocols libxkbcommon-dev libudev-dev \
            libinput-dev libpixman-1-dev libseat-dev \
            libdrm-dev libgbm-dev libegl1-mesa-dev libgles2-mesa-dev \
            libsdl2-dev libxcb1-dev libxcb-composite0-dev \
            xwayland python3-pip curl wget unzip xauth dbus-x11 \
            novnc websockify tigervnc-standalone-server \
            libgl1-mesa-dri libosmesa6 mesa-utils mesa-va-drivers

      - name: Install virglrenderer (Virtual GPU)
        run: |
          sudo apt install -y virglrenderer1 virt-viewer libvirt-daemon-system

      - name: Install Latest Hyprland Release (.deb)
        run: |
          HYPR_VER=$(curl -s https://api.github.com/repos/hyprwm/Hyprland/releases/latest | grep tag_name | cut -d '"' -f4)
          wget https://github.com/hyprwm/Hyprland/releases/download/$HYPR_VER/hyprland_${HYPR_VER#v}_amd64.deb
          sudo apt install -y ./hyprland_${HYPR_VER#v}_amd64.deb || true

      - name: Install Hyprdots dependencies
        run: |
          sudo apt install -y \
            kitty rofi-wayland swww waybar mako-notifier \
            fonts-font-awesome starship zsh fish
          pip3 install --user pywal

      - name: Clone Hyprdots
        run: |
          git clone https://github.com/end-4/dots-hyprland ~/hyprdots
          cd ~/hyprdots
          chmod +x setup

      - name: Install Hyprdots
        run: |
          cd ~/hyprdots
          ./setup install || true

      - name: Hyprland headless config
        run: |
          mkdir -p ~/.config/hypr
          cat > ~/.config/hypr/headless.conf <<EOF
          monitor=,preferred,auto,1
          exec-once=swww init
          exec-once=waybar
          exec-once=mako
          exec-once=kitty
          EOF

      - name: Start Hyprland with Virtual GPU
        run: |
          export WLR_BACKENDS=headless
          export WLR_RENDERER=vulkan
          export LIBGL_ALWAYS_SOFTWARE=0
          export MESA_LOADER_DRIVER_OVERRIDE=virtio_gpu
          export GALLIUM_DRIVER=virgl
          export WLR_RENDERER_ALLOW_SOFTWARE=1

          Hyprland --config ~/.config/hypr/headless.conf &
          sleep 7

      - name: Start VNC server (wayvnc)
        run: |
          echo "" > ~/.vncpass
          wayvnc --address 0.0.0.0 --password-file ~/.vncpass &
          sleep 5

      - name: Start WebVNC (noVNC)
        run: |
          websockify --web /usr/share/novnc/ 6080 localhost:5900 &
          sleep 3

      - name: Install cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Expose via Cloudflare Tunnel
        run: |
          cloudflared tunnel --url http://localhost:6080 --no-autoupdate > log.txt 2>&1 &
          sleep 7
          echo "========================================"
          echo "URL:"
          grep -o 'https://.*trycloudflare.com' log.txt
          echo "========================================"

      - name: Keep Alive
        run: tail -f /dev/null
