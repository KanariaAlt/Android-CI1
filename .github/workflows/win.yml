name: Windows-noVNC-Cloudflare

on:
  workflow_dispatch:

jobs:
  novnc:
    runs-on: windows-latest

    steps:
    - name: Download noVNC
      run: |
        curl -LO https://github.com/novnc/noVNC/archive/refs/heads/master.zip
        tar -xf master.zip
        mv noVNC-master C:\noVNC

    - name: Download websockify
      run: |
        curl -LO https://github.com/novnc/websockify/archive/refs/heads/master.zip
        tar -xf master.zip
        mv websockify-master C:\websockify

    - name: Install Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Enable RDP
      run: |
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

    - name: Start websockify
      run: |
        Start-Process -WindowStyle Hidden python -ArgumentList "C:\websockify\websockify.py 6081 localhost:3389"

    - name: Start noVNC
      run: |
        Start-Process -WindowStyle Hidden python -ArgumentList "C:\noVNC\utils\launch.py --vnc localhost:6081 --listen 6080"

    - name: Download Cloudflared
      run: |
        curl -LO https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe
        ren cloudflared-windows-amd64.exe cloudflared.exe
        move cloudflared.exe C:\cloudflared.exe

    - name: Start Cloudflare Tunnel (no input redirection)
      run: |
        New-Item -ItemType Directory -Path C:\cf > $null
        Start-Process -WindowStyle Hidden `
          -FilePath "C:\cloudflared.exe" `
          -ArgumentList "tunnel --url http://localhost:6080 --no-autoupdate --logfile C:\cf\log.txt"

        # beri waktu cloudflared untuk generate URL
        Start-Sleep -Seconds 8

    - name: Print Tunnel URL
      run: |
        Get-Content C:\cf\log.txt | Select-String "https://"

    - name: Keep runner alive
      run: |
        ping -t 127.0.0.1 >NUL
