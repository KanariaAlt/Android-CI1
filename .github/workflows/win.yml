name: Windows RDP + Cloudflare Tunnel (6 Hours Runtime)

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360   # 6 jam

    steps:

    - name: Set RDP Password
      run: net user runneradmin "Password123!"
      shell: powershell

    - name: Enable Windows RDP
      run: |
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name fDenyTSConnections -Value 0
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name UserAuthentication -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
      shell: powershell

    - name: Install Google Chrome
      run: |
        choco install googlechrome -y
      shell: powershell

    - name: Install cloudflared
      run: choco install cloudflared -y
      shell: powershell

    - name: Start Cloudflare Tunnel
      run: |
        $log = "$env:USERPROFILE\.cloudflared\cloudflared.log"
        Start-Process -NoNewWindow cloudflared -ArgumentList "tunnel --url rdp://localhost:3389" -RedirectStandardOutput $log -RedirectStandardError $log
        Start-Sleep -Seconds 10
      shell: powershell

    - name: Print Tunnel URL
      run: |
        $log = "$env:USERPROFILE\.cloudflared\cloudflared.log"

        echo "======================================"
        echo " Cloudflare Tunnel URL:"
        echo "======================================"

        if (Test-Path $log) {
          $line = (Get-Content $log -Tail 50 | Select-String "trycloudflare")[-1]
          echo $line
        } else {
          echo "Log file not found!"
        }

        echo ""
        echo "RDP Login:"
        echo "  User: runneradmin"
        echo "  Pass: Password123!"
        echo ""
        echo "Runner will stay online for 6 hours..."
      shell: powershell

    - name: Keep Alive 6 Hours
      run: |
        echo "Starting 6-hour keep alive loop..."
        for ($i = 0; $i -lt 21600; $i++) {
          Start-Sleep -Seconds 1
        }
      shell: powershell
