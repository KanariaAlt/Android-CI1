name: macOS noVNC

on:
  workflow_dispatch:

jobs:
  novnc:
    runs-on: macos-13

    steps:
      - name: Install dependencies
        run: |
          brew install --cask xquartz
          brew install x11vnc
          brew install python
          brew install openbox
          pip3 install websockify
          git clone https://github.com/novnc/noVNC.git

      - name: Start XQuartz properly
        run: |
          # Start XQuartz in background
          open -a XQuartz
          sleep 8

          # Create .Xauthority so display is valid
          touch ~/.Xauthority

          # Force DISPLAY variable
          export DISPLAY=:0

          # Enable insecure IGLX (required in headless CI)
          defaults write org.xquartz.X11 enable_iglx -bool true
          defaults write org.xquartz.X11 nolisten_tcp -bool false

          # Restart XQuartz for settings to apply
          killall Xquartz || true
          open -a XQuartz
          sleep 8

      - name: Start Openbox (X11 Window Manager)
        run: |
          export DISPLAY=:0
          nohup openbox-session > openbox.log 2>&1 &
          sleep 2

      - name: Start x11vnc with no password
        run: |
          export DISPLAY=:0

          # Force x11vnc to capture framebuffer even if XQuartz is slow
          nohup x11vnc \
            -display :0 \
            -nopw \
            -forever \
            -shared \
            -noxdamage \
            -alwaysshared \
            -xkb \
            -repeat \
            -cursor arrow \
            -rfbport 5900 > vnc.log 2>&1 &

          sleep 3

      - name: Start Websockify
        run: |
          nohup websockify --web noVNC 6080 localhost:5900 &
          sleep 3

      - name: Install cloudflared
        run: |
          brew install cloudflared

      - name: Start Cloudflare Tunnel
        run: |
          nohup cloudflared tunnel --url http://localhost:6080 > tunnel.log &
          sleep 5

      - name: Show noVNC URL
        run: |
          grep -Eo "https://.*trycloudflare.com" tunnel.log | head -n 1

      - name: Keep alive
        run: sleep 36000
