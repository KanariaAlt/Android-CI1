name: macOS noVNC

on:
  workflow_dispatch:

jobs:
  macos-novnc:
    runs-on: macos-13

    steps:
      - name: Install dependencies
        run: |
          brew install python3
          pip3 install websockify
          git clone https://github.com/novnc/noVNC.git

      - name: Enable VNC & Create user
        run: |
          echo "[+] Creating VNC user"
          sudo sysadminctl -addUser RenzAlt -password  -admin

          echo "[+] Enable Remote Management (VNC server)"
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw password \
            -restart -agent -privs -all

          echo "[+] Enable ScreenSharing"
          sudo defaults write /var/db/launchd.db/com.apple.launchd/overrides.plist \
            com.apple.screensharing -dict Disabled -bool false

          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist || true

      - name: Start Websockify (TCP â†’ WebSocket)
        run: |
          nohup websockify --web noVNC 6080 localhost:5900 &
          sleep 3

      - name: Install ngrok
        run: |
          brew install --cask ngrok
        env:
          HOMEBREW_NO_AUTO_UPDATE: 1

      - name: Start ngrok tunnel
        run: |
          echo "$NGROK_AUTHTOKEN" | ngrok config add-authtoken -
          ngrok http 6080 > ngrok.log &
          sleep 5

      - name: Show public noVNC URL
        run: |
          echo "Open this in browser:"
          grep -Eo "https://[0-9a-z\-]*\.ngrok.io" ngrok.log | head -n 1

      - name: Keep session alive
        run: |
          echo "Username: RenzAlt"
          sleep 36000
